```{r}
library(survey)
library(readxl)
library(dplyr)
library(stringr)
library(tidyverse)
library(readr)
```


#Task1

```{r}
df <- read.csv("final_sample.csv")
# Create stratum variable (Region)
df$stratum <- df$Region

# Create SECU variable (District as proxy for PSUs)
df$SECU <- as.factor(df$District_Name)

secu_counts <- df %>%
  group_by(stratum) %>%
  summarise(
    n_secus = n_distinct(SECU),
    sample_size = n()
  )

print(secu_counts)


df$SECU <- as.factor(df$District_Name)  # PSUs should be districts, not regions

# Combine small strata (Regions 1-4) into a single stratum
df$stratum_combined <- ifelse(df$Region %in% 1:4, 0, df$Region)

# Verify we now have ≥2 PSUs per stratum
df %>% 
  group_by(stratum_combined) %>% 
  summarise(n_districts = n_distinct(SECU))
```



```{r}
# Create survey design with combined strata
df$District_Name[is.na(df$District_Name)] <- "Unknown_District"

# Then proceed with design
design <- svydesign(
  id = ~SECU,
  strata = ~stratum_combined,
  weights = ~tot_all,
  data = df,
  nest = TRUE
)
# Now BRR will work because all strata have ≥2 PSUs
rep_design <- as.svrepdesign(design, type = "BRR")
```
